<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Scrollbar Premium */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Background do Chat */
        .chat-bg {
            background-color: #eef2f6;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Anima√ß√µes */
        .fade-in-up { animation: fadeInUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .avatar-circle {
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 14px; letter-spacing: -0.5px;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' },
                        chat: { sent: '#e0f2fe', received: '#ffffff' }
                    }
                }
            }
        }
    </script>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 shrink-0 z-20 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-brand-600 text-white p-1.5 rounded-lg shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>
            </div>
            <h1 class="font-semibold text-slate-700 tracking-tight text-lg">Central de Atendimento Villanet</h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 bg-emerald-50 text-emerald-700 px-3 py-1 rounded-full border border-emerald-100 text-xs font-medium">
                <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                Sistema Online
            </div>
            <a href="/logout" class="text-slate-400 hover:text-red-500 text-sm font-medium transition-colors flex items-center gap-1" title="Sair do Sistema">
                Sair
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
            </a>
        </div>
    </header>

    <main class="flex-grow flex h-full overflow-hidden">
        
        <aside class="w-full md:w-80 lg:w-96 bg-white border-r border-slate-200 flex flex-col z-10">
            <div class="p-4 border-b border-slate-100">
                <div class="relative">
                    <svg class="absolute left-3 top-2.5 h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    <input type="text" placeholder="Buscar conversa..." class="w-full bg-slate-50 border border-slate-200 text-sm rounded-lg pl-9 pr-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:bg-white transition-all">
                </div>
            </div>

            <div id="conversas-list" class="flex-grow overflow-y-auto p-2 space-y-1">
                <div class="flex flex-col items-center justify-center h-40 text-slate-400">
                    <svg class="animate-spin h-6 w-6 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span class="text-xs">Sincronizando...</span>
                </div>
            </div>

            <div class="p-2 border-t border-slate-100 text-center">
                <span class="text-[10px] text-slate-400 uppercase tracking-wider font-semibold">Atualizado: <span id="last-update">--:--</span></span>
            </div>
        </aside>

        <section class="flex-grow flex flex-col bg-slate-50 relative min-w-0">
            
            <div id="conversa-header" class="h-16 border-b border-slate-200 bg-white flex justify-between items-center px-6 hidden shadow-sm z-10">
                <div class="flex items-center gap-3">
                    <div id="header-avatar" class="w-10 h-10 rounded-full bg-slate-200 avatar-circle text-slate-600">--</div>
                    <div>
                        <h2 id="conversa-titulo" class="font-bold text-slate-800 leading-tight">Cliente</h2>
                        <div class="flex items-center gap-1">
                            <svg class="w-3 h-3 text-brand-500" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.891-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.463 1.065 2.876 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                            <p id="conversa-subtitulo" class="text-xs text-slate-500 font-medium">WhatsApp</p>
                        </div>
                    </div>
                </div>
                <button onclick="carregarMensagens(true)" class="text-slate-400 hover:text-brand-600 hover:bg-brand-50 p-2 rounded-full transition" title="Atualizar Chat">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                </button>
            </div>

            <div id="empty-state" class="flex-grow flex flex-col items-center justify-center text-slate-400 chat-bg">
                <div class="bg-white p-6 rounded-full shadow-sm mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                </div>
                <h3 class="text-lg font-semibold text-slate-600">Nenhuma conversa selecionada</h3>
                <p class="text-sm">Escolha um contato √† esquerda para come√ßar.</p>
            </div>

            <div id="mensagens-view" class="flex-grow p-6 overflow-y-auto chat-bg hidden flex flex-col gap-3">
            </div>

            <div id="resposta-area" class="p-4 bg-white border-t border-slate-200 hidden">
                <div class="max-w-4xl mx-auto relative flex items-end gap-2 bg-slate-50 border border-slate-300 rounded-2xl p-2 focus-within:ring-2 focus-within:ring-brand-500 focus-within:border-transparent focus-within:bg-white transition-all shadow-sm">
                    <textarea id="reply-input" class="w-full bg-transparent border-none focus:ring-0 resize-none text-sm text-slate-700 max-h-32 py-2 px-2" rows="1" placeholder="Digite sua mensagem..."></textarea>
                    
                    <button id="send-reply-btn" class="mb-1 mr-1 bg-brand-600 hover:bg-brand-700 text-white p-2 rounded-xl shadow-sm transition-colors flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform rotate-90" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                    </button>
                </div>
                <p class="text-center text-[10px] text-slate-400 mt-2">Pressione <b>Shift + Enter</b> para pular linha. <b>Enter</b> para enviar.</p>
            </div>
        </section>
    </main>

    <audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const API_BASE_URL = ''; 
        const REFRESH_RATE = 1000; // Turbo Mode (1s)

        // --- ESTADO ---
        let currentConversaId = null;
        let lastJsonSignature = ''; // Assinatura de conte√∫do
        let isUserScrolling = false;
        let globalConversas = []; 

        // Cores de Avatar
        const avatarColors = [
            'bg-red-100 text-red-600', 'bg-orange-100 text-orange-600', 'bg-amber-100 text-amber-600',
            'bg-green-100 text-green-600', 'bg-emerald-100 text-emerald-600', 'bg-teal-100 text-teal-600',
            'bg-cyan-100 text-cyan-600', 'bg-sky-100 text-sky-600', 'bg-blue-100 text-blue-600',
            'bg-indigo-100 text-indigo-600', 'bg-violet-100 text-violet-600', 'bg-purple-100 text-purple-600',
            'bg-fuchsia-100 text-fuchsia-600', 'bg-pink-100 text-pink-600', 'bg-rose-100 text-rose-600'
        ];

        // Elementos
        const els = {
            list: document.getElementById('conversas-list'),
            msgs: document.getElementById('mensagens-view'),
            empty: document.getElementById('empty-state'),
            header: document.getElementById('conversa-header'),
            inputArea: document.getElementById('resposta-area'),
            title: document.getElementById('conversa-titulo'),
            headerAvatar: document.getElementById('header-avatar'),
            input: document.getElementById('reply-input'),
            btn: document.getElementById('send-reply-btn'),
            audio: document.getElementById('notification-sound'),
            lastUpdate: document.getElementById('last-update')
        };

        // --- HELPERS ---
        const getInitials = (name) => {
            if(!name) return '?';
            const parts = name.trim().split(' ');
            if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        };

        const getColorClass = (name) => {
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return avatarColors[Math.abs(hash) % avatarColors.length];
        };

        const formatarHora = (isoDate) => {
            const d = new Date(isoDate);
            const hoje = new Date();
            const isToday = d.getDate() === hoje.getDate() && d.getMonth() === hoje.getMonth();
            if (isNaN(d.getTime())) return '';
            if (isToday) return d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        };

        const playSound = () => {
            els.audio.currentTime = 0;
            els.audio.play().catch(() => {});
        };

        // --- L√ìGICA PRINCIPAL ---

        // 1. BUSCAR CONVERSAS (TODAS)
        const fetchConversas = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/api/conversas?t=${Date.now()}`);
                if (!response.ok) return;
                
                const conversas = await response.json();
                globalConversas = conversas;
                renderConversas(conversas);
                if(els.lastUpdate) els.lastUpdate.innerText = formatarHora(new Date());
            } catch (e) { console.error("Polling erro:", e); }
        };

        const renderConversas = (conversas) => {
            if (conversas.length === 0) {
                els.list.innerHTML = `
                    <div class="text-center mt-10 p-4">
                        <div class="bg-slate-100 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-2">
                            <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
                        </div>
                        <p class="text-slate-500 text-sm">Nenhuma conversa</p>
                    </div>`;
                return;
            }

            // Preserva scroll da lista
            // const scrollPos = els.list.scrollTop; 

            const html = conversas.map(c => {
                const isActive = c.id === currentConversaId;
                const initials = getInitials(c.cliente.nome);
                const colorClass = getColorClass(c.cliente.nome);

                return `
                <div onclick="selecionarConversa('${c.id}')" 
                     class="cursor-pointer p-3 border-b border-slate-100 transition-all duration-200 ${isActive ? 'bg-brand-50' : 'hover:bg-slate-50'} group">
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full ${colorClass} avatar-circle shadow-sm">
                            ${initials}
                        </div>
                        <div class="flex-grow min-w-0">
                            <div class="flex justify-between items-baseline mb-0.5">
                                <h3 class="text-sm font-semibold text-slate-800 truncate ${isActive ? 'text-brand-700' : ''}">${c.cliente.nome}</h3>
                                <span class="text-[10px] text-slate-400 font-medium whitespace-nowrap ml-2">${c.ultima_interacao ? formatarHora(c.ultima_interacao) : ''}</span>
                            </div>
                            <p class="text-xs text-slate-500 truncate group-hover:text-slate-600 transition-colors">
                                ${c.resumo_mensagem}
                            </p>
                        </div>
                    </div>
                </div>`;
            }).join('');

            if (els.list.innerHTML !== html) {
                els.list.innerHTML = html;
                // els.list.scrollTop = scrollPos; // Opcional
            }
        };

        // 2. SELECIONAR CONVERSA
        window.selecionarConversa = (id) => {
            if (currentConversaId === id) return;

            currentConversaId = id;
            
            const chat = globalConversas.find(c => c.id === id);
            if (chat) {
                els.title.innerText = chat.cliente.nome;
                els.headerAvatar.className = `w-10 h-10 rounded-full avatar-circle shadow-sm flex-shrink-0 ${getColorClass(chat.cliente.nome)}`;
                els.headerAvatar.innerText = getInitials(chat.cliente.nome);
            }

            lastJsonSignature = ''; // For√ßa re-render
            
            // Toggle UI
            els.empty.classList.add('hidden');
            els.header.classList.remove('hidden'); els.header.classList.add('flex');
            els.msgs.classList.remove('hidden');
            els.inputArea.classList.remove('hidden');
            
            els.input.focus();
            
            fetchConversas(); 
            carregarMensagens(true); 
        };

        // 3. CARREGAR MENSAGENS (COM JSON SIGNATURE)
        const carregarMensagens = async (forceScroll = false) => {
            if (!currentConversaId) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/mensagens/${currentConversaId}?t=${Date.now()}`);
                if (!response.ok) return;

                const mensagens = await response.json();
                
                // Assinatura para detectar mudan√ßas reais
                const currentSignature = JSON.stringify(mensagens);

                if (currentSignature !== lastJsonSignature || forceScroll) {
                    
                    // Som de nova msg
                    if (mensagens.length > 0) {
                        const lastMsg = mensagens[mensagens.length - 1];
                        // S√≥ toca se for cliente e n√£o for o primeiro load
                        if (lastMsg.origem === 'cliente' && lastJsonSignature !== '') {
                            playSound();
                            document.title = "üí¨ Nova Mensagem!";
                            setTimeout(() => document.title = "Gestor de Atendimento", 4000);
                        }
                    }

                    lastJsonSignature = currentSignature;
                    renderMensagens(mensagens);
                    
                    if (!isUserScrolling || forceScroll) {
                        scrollToBottom();
                    }
                }
            } catch (e) { console.error("Polling msg erro:", e); }
        };

        const renderMensagens = (mensagens) => {
            if (mensagens.length === 0) {
                els.msgs.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-slate-400">
                        <span class="text-sm bg-slate-200 px-3 py-1 rounded-full mb-2">In√≠cio da conversa</span>
                        <p class="text-xs">As mensagens s√£o protegidas de ponta a ponta.</p>
                    </div>`;
                return;
            }

            const html = mensagens.map((m, index) => {
                const isMe = m.origem === 'agente';
                const prevIsMe = index > 0 ? mensagens[index-1].origem === m.origem : false;
                const marginTop = prevIsMe ? 'mt-1' : 'mt-4';
                
                const bubbleClass = isMe 
                    ? 'bg-brand-600 text-white rounded-2xl rounded-tr-none shadow-sm' 
                    : 'bg-white text-slate-800 rounded-2xl rounded-tl-none shadow-sm border border-slate-100';

                return `
                <div class="flex ${isMe ? 'justify-end' : 'justify-start'} ${marginTop} fade-in-up">
                    <div class="max-w-[85%] lg:max-w-[70%] relative group">
                        <div class="${bubbleClass} px-4 py-2 relative">
                            <p class="whitespace-pre-wrap leading-relaxed text-sm">${m.texto}</p>
                            <div class="flex justify-end items-center gap-1 mt-1 select-none">
                                <span class="text-[10px] ${isMe ? 'text-brand-100' : 'text-slate-400'}">
                                    ${formatarHora(m.data_envio)}
                                </span>
                                ${isMe ? '<svg class="w-3 h-3 text-brand-200" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            els.msgs.innerHTML = html;
        };

        const scrollToBottom = () => {
            els.msgs.scrollTop = els.msgs.scrollHeight;
        };

        // 4. ENVIAR (COM UPDATE IMEDIATO)
        const enviarResposta = async () => {
            const texto = els.input.value.trim();
            if (!currentConversaId || !texto) return;

            const originalIcon = els.btn.innerHTML;
            
            // UX Imediata
            els.input.value = '';
            els.input.style.height = 'auto'; 
            els.input.focus();

            // √çcone Loading
            els.btn.disabled = true;
            els.btn.innerHTML = '<svg class="animate-spin h-5 w-5 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

            try {
                await fetch(`${API_BASE_URL}/api/enviar_resposta`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ conversa_id: currentConversaId, texto_resposta: texto })
                });
                
                // Turbo Update
                setTimeout(() => carregarMensagens(true), 300);
                fetchConversas(); 

            } catch (e) {
                alert('Erro ao enviar mensagem.');
                els.input.value = texto; // Restaura texto
            } finally {
                els.btn.disabled = false;
                els.btn.innerHTML = originalIcon;
            }
        };

        // Listeners
        els.btn.onclick = enviarResposta;
        
        els.input.onkeydown = (e) => { 
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                enviarResposta(); 
            }
        };

        // Scroll Detector
        els.msgs.addEventListener('scroll', () => {
            const distanceToBottom = els.msgs.scrollHeight - els.msgs.scrollTop - els.msgs.clientHeight;
            isUserScrolling = distanceToBottom > 100;
        });

        // Init Loops
        setInterval(fetchConversas, 4000);
        setInterval(() => { if (currentConversaId) carregarMensagens(); }, REFRESH_RATE);
        fetchConversas();

    </script>
</body>
</html>